---
title: Upgrade from V3 to V4
summary: Instructions on how to upgrade from NServiceBus versions 3 to 4 
tags:
- upgrade
- migration
---

Upgrading 3.x to 4.x it should be relatively straight forward.

### If you are using nuget

For each NServiceBus package, in the nuget management console type
 
` update-package NServiceBus -vresion 4.<latest v4 version>`

### Prerequisite: NServiceBus V4.0 requires RavenDB 2.0.0.2261 or later
NServiceBus V4.0 requires the latest RavenDB v2.x to be installed on the same machine. 

### Namespace changes to Types and Interfaces
### INeedInitialization
Prior to NServicebus 4.0, The interface INeedInitialization was defined in NServiceBus.Config. In NServicebus 4.0, it is defined at the higher namespace level, i.e NServiceBus. If you receive the following compiler error, please remove the using reference to NServiceBus.Config and resolve using NServiceBus: error CS0104:

    'INeedInitialization' is an ambiguous reference between 'NServiceBus.INeedInitialization' and 'NServiceBus.Config.INeedInitialization'

### Working with Error and Audit queues
The Management Service (now called ServiceConbtrol) (installed with NServiceBus V4.0) consumes the messages from the defined MSMQ Error and Audit queues. While the Management Service is running, you can view the the Error messages by viewing the Error.log queue, and auditing data can be viewed using [ServiceInsight](http://particular.net/ServiceInsight). 

### Autosubscriptions
Only messages marked as events (IEvent or DefiningEventsAs()) will be auto-subscribed.

### Default transaction isolation level

The default transaction isolation level is now ReadCommitted. To revert to Serializable, use this code:
```
Configure.Transactions.Advanced(settings => 
   settings.IsolationLevel(IsolationLevel.Serializable));
```
**SecondLevelRetries**: The type SecondLevelRetries (used in the NServiceBus.Management.Retries namespace to configure the retry and the timeout policy) has been moved to the NServiceBus.Features namespace. While version 3.3.x had a separate policy for managing second level retries and timeouts, this has been merged into the new RetryPolicy in NServiceBus 4.0 and it is capable of achieving both functions.

### breaking changes

#### PowerShell cmdlets
NServiceBus.Host no longer supports /installinfrastructure. Use PowerShell cmdlets instead.
PowerShell cmdlets have been renamed so that they do not clash with any existing cmdlets. 

####NServiceBus.WebService: 
Exposing an endpoint as a WebService using `NServiceBus.Webservice<YourMessage, YourEnum>` has been deprecated in 4.0. Use the WcfService option instead. For example:

    YourWcfService : WcfService<YourMessage, YourEnum>
 
#### TransactionalTransport
The type TransactionalTransport, which used to be defined in the namespace NServiceBus.Unicast.Transport.Transactional has been renamed to TransportReceiver and moved to the namespace NServiceBus.Unicast.Transport. If you receive the following compiler error, resolve using the new namespace specified above.

    error CS0246: The type or namespace name 'TransactionalTransport' could not be found (are you missing a using directive or an assembly reference?)

### New Transports Support and Configuration
These new transport samples were added to the NServiceBus samples, illustrating how to configure the new transports:
- Messaging.ActiveMQ
- Messaging.RabbitMQ
- Messaging.SqlServer
- Messaging.MSMQ

####New configuration APIs
To simplify the transports configuration and make it consistent across all transports. 
In your config file, specify a connection string, like this:

<!-- import TRANSCONFIGV4 -->

You then have two options to specify the transport:
Specify it as part of the `IConfigureThisEndpoint` class declaration, e.g.:
```
public class  EndpointConfig : IConfigureThisEndpoint, AsA_Server, 
       UsingTransport<RabbitMQ>
```
Or specify it in the `IWantCustomInitialization.Init` method, 
```
public class EndpointConfig : IConfigureThisEndpoint, AsA_Server, 
IWantCustomInitialization
{
   public void Init(){
      Configure.With().DefaultBuilder()
         .UseTransport<RabbitMQ>()
   }
}
```
### New NuGet packages for the new transports 

These NuGet packages are also available:

- [NServiceBus.SqlServer](https://nuget.org/packages/NServiceBus.SqlServer/)
- [NServiceBus.ActiveMQ](https://nuget.org/packages/NServiceBus.ActiveMQ/)
- [NServiceBus.RabbitMQ](https://nuget.org/packages/NServiceBus.RabbitMQ/)

Example of how to install the NServiceBus.ActiveMQ package

    PM> Install-Package NServiceBus.ActiveMQ

### New Transport DLLs 

Add a reference to the new transport DLLs (in the Binaries directory):

- NServiceBus.Transports.RabbitMQ.dll
- NServiceBus.Transports.SQlServer.dll
- NServiceBus.Transports.ActiveMQ.dll

MSMQ is currently in NServiceBus.Core.dll and does not require any additional reference. NuGet adds the reference automatically.

### Configuration Changes

#### XmlMessageSerializer
Now supports not wrapping messages in a <messages> element for single messages. This makes interoperability with other systems easier.
To turn on this feature:

    .XmlSerializer( dontWrapSingleMessages: true )
 
####MsmqTransportConfig
The MsmqTransportConfig section has been deprecated in favour of TransportConfig section, like this:
```
<section name="TransportConfig" 
   type="NServiceBus.Config.TransportConfig, NServiceBus.Core"/>
<TransportConfig MaximumConcurrencyLevel="10" MaxRetries="3" 
   MaximumMessageThroughputPerSecond="10"/>
``` 
#### INeedToInstallSomething

The INeedToInstallSomething interface is now resolved via the container.
 
#### NHibernate Configuration 

NHibernate settings have been simplified, as follows:

<!-- import NHIBERNATECONFIG_V4 -->
### Performance Counters 

New throughput performance counters and updated performance counters are available:

### NServiceBus license installed per machine 

Licenses can now be installed in HKLM, allowing you to install one license per server instead of installing a license per endpoint or per Windows account.

    LicenseInstaller.exe C:\License.xml

## Powershell cmdlet Updates 

NServiceBus PowerShell cmdlets have moved to NServiceBus.PowerShell.dll. To import it, run this:

    PM> Import-Module .\NServiceBus.PowerShell.dll

NServiceBus Powershell cmdlets have been renamed so they do not clash with any existing cmdlets:

 * Installs a NServiceBus license file.
   `Install-NServiceBusLicense`
 * Displays all messages in a queue.
   `Get-NServiceBusMSMQMessage`
 * Displays the NServiceBus installed version.
   `Get-NServiceBusVersion`
 * Installs DTC on the machine.
   `Install-NServiceBusDTC`
 * Installs RavenDB on the machine.
   `Install-NServiceBusRavenDB`
 * Installs NServiceBus performance counters on the machine.
   `Install-NServiceBusPerformanceCounters`
 * Installs MSMQ on the machine.
   `Install-NServiceBusMSMQ`
 * Validates if DTC is installed and running on the machine.
   `Test-NServiceBusDTCInstallation`
 * Ensures RavenDB is on the machine.
   `Test-NServiceBusRavenDBInstallation`
 * Validates that NServiceBus performance counters are correctly installed on the machine.
   `Test-NServiceBusPerformanceCountersInstallation`
 * Validates MSMQ is correctly installed on the machine.
   `Test-NServiceBusMSMQInstallation`
 * Adds the required configuration section to the config file.
   `Add-NServiceBusMessageForwardingInCaseOfFaultConfig`
 * Shows the default error and audit queues.
   `Get-NServiceBusLocalMachineSettings`
 * Allows specifying the default error and audit queues.
   `Set-NServiceBusLocalMachineSettings`
 * NServiceBus.Host no longer supports /installinfrastructure. Use   PowerShell cmdlets instead.

## New Endpoint Configuration API

Sample usage:
```
Configure.Endpoint.AsSendOnly()
   .Advanced(settings => settings.DisableDurableMessages());
Configure.Transactions.Enable() 
   .Advanced(settings => settings.IsolationLevel(IsolationLevel.Serializable)
   .DefaultTimeout(TimeSpan.FromSeconds(40)) 
   .DisableDistributedTransactions()); 
```

## Embedded RavenDB 

RavenDB is not ilmerged anymore. It is embedded instead, using  https://github.com/Fody/Costura#readme.
The embedding enables client updates (but may require binding redirects). It also allows passing your own DocumentStore, thereby providing full configuration flexibility. 
Audit and Error Queue Defaults  
Server defaults for audit and error queues can now be specified in the registry (see new PowerShell cmdlet Get/Set-NServiceBusLocalMachineSettings, above).

For more details look at release notes(https://github.com/Particular/NServiceBus/releases/tag/4.0.0)

### Next Upgrade
[V 4.x to v 5.x](4to5)